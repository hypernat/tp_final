<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Usuarios</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <link rel="icon" href="imagenes/favicon.ico" type="image/x-icon" />
</head>
<body class="section">

  <h1 class="title">Panel de Usuarios</h1>

  <!-- FORMULARIO AGREGAR USUARIO -->
  <div class="box">
    <h2 class="subtitle">Agregar nuevo usuario</h2>
    <form id="addUsuarioForm">
      <div class="field">
        <label class="label">Nombre</label>
        <div class="control">
          <input class="input" type="text" name="nombre" required />
        </div>
      </div>

      <div class="field">
        <label class="label">Email</label>
        <div class="control">
          <input class="input" type="email" name="email" required />
        </div>
      </div>

      <div class="field">
        <label class="label">Teléfono</label>
        <div class="control">
          <input class="input" type="tel" name="telefono" required />
        </div>
      </div>

      <div class="field">
        <label class="label">Dirección</label>
        <div class="control">
          <input class="input" type="text" name="direccion" required />
        </div>
      </div>

      <div class="field">
        <label class="checkbox">
          <input type="checkbox" name="tiene_patio" />
          Tiene patio
        </label>
      </div>

      <div class="field">
        <label class="checkbox">
          <input type="checkbox" name="tiene_mas_mascotas" />
          Tiene más mascotas
        </label>
      </div>

      <div class="control">
        <button class="button is-primary" type="submit">Agregar</button>
      </div>
    </form>
  </div>

  <!-- LISTA DE USUARIOS -->
  <div class="box">
    <h2 class="subtitle">Usuarios registrados</h2>
    <table class="table is-striped is-fullwidth" id="usuariosTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Email</th>
          <th>Teléfono</th>
          <th>Dirección</th>
          <th>Patio</th>
          <th>Más Mascotas</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filas cargadas dinámicamente -->
      </tbody>
    </table>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/index/usuarios';

    async function cargarUsuarios() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('Error al cargar usuarios');
        const usuarios = await res.json();
        const tbody = document.querySelector('#usuariosTable tbody');
        tbody.innerHTML = '';

        usuarios.forEach(user => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.nombre}</td>
            <td>${user.email}</td>
            <td>${user.telefono}</td>
            <td>${user.direccion}</td>
            <td>${user.tiene_patio ? 'Sí' : 'No'}</td>
            <td>${user.tiene_mas_mascotas ? 'Sí' : 'No'}</td>
            <td>
              <button class="button is-small is-warning" onclick="editarUsuario(${user.id}, '${escapeHtml(user.nombre)}', '${escapeHtml(user.email)}', '${escapeHtml(user.telefono)}', '${escapeHtml(user.direccion)}', ${user.tiene_patio}, ${user.tiene_mas_mascotas})">Editar</button>
              <button class="button is-small is-danger" onclick="eliminarUsuario(${user.id})">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        alert('No se pudieron cargar los usuarios.');
        console.error(error);
      }
    }

    document.getElementById('addUsuarioForm').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      const data = {
        nombre: form.nombre.value.trim(),
        email: form.email.value.trim(),
        telefono: form.telefono.value.trim(),
        direccion: form.direccion.value.trim(),
        tiene_patio: form.tiene_patio.checked,
        tiene_mas_mascotas: form.tiene_mas_mascotas.checked
      };

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Error al agregar usuario');
        }
        form.reset();
        cargarUsuarios();
      } catch (error) {
        alert(error.message);
      }
    });

    async function eliminarUsuario(id) {
      if (confirm('¿Eliminar este usuario?')) {
        try {
          const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Error al eliminar usuario');
          cargarUsuarios();
        } catch (error) {
          alert(error.message);
        }
      }
    }

    async function editarUsuario(id, nombreActual, emailActual, telefonoActual, direccionActual, patioActual, masMascotasActual) {
      const nuevoNombre = prompt('Nuevo nombre:', nombreActual);
      if (!nuevoNombre) return alert('Nombre es obligatorio.');

      const nuevoEmail = prompt('Nuevo email:', emailActual);
      if (!nuevoEmail) return alert('Email es obligatorio.');

      const nuevoTelefono = prompt('Nuevo teléfono:', telefonoActual);
      if (!nuevoTelefono) return alert('Teléfono es obligatorio.');

      const nuevaDireccion = prompt('Nueva dirección:', direccionActual);
      if (!nuevaDireccion) return alert('Dirección es obligatoria.');

      const nuevoTienePatio = confirm('¿Tiene patio? OK = Sí, Cancelar = No');
      const nuevoTieneMasMascotas = confirm('¿Tiene más mascotas? OK = Sí, Cancelar = No');

      const data = {
        nombre: nuevoNombre.trim(),
        email: nuevoEmail.trim(),
        telefono: nuevoTelefono.trim(),
        direccion: nuevaDireccion.trim(),
        tiene_patio: nuevoTienePatio,
        tiene_mas_mascotas: nuevoTieneMasMascotas
      };

      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Error al actualizar usuario');
        }
        cargarUsuarios();
      } catch (error) {
        alert(error.message);
      }
    }

    // Función para escapar caracteres en HTML (previene problemas con comillas en prompt)
    function escapeHtml(text) {
      return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    // Carga inicial
    cargarUsuarios();
  </script>

  <div class="buttons mt-5">
    <a href="index.html" class="button is-link">Volver al Inicio</a>
  </div>

</body>
</html>
